<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CertiChain | Blockchain Verification</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Orbitron:wght@500&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --glass: rgba(255, 255, 255, 0.95); }
        
        body { 
            font-family: 'Roboto', sans-serif; 
            background: linear-gradient(135deg, #1e3c72, #2a5298); 
            min-height: 100vh; 
            margin: 0; padding: 20px; 
            display: flex; justify-content: center; align-items: center;
        }

        /* Card Container */
        .container { 
            width: 100%; max-width: 900px; 
            background: var(--glass); 
            border-radius: 20px; 
            padding: 30px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            text-align: center;
            backdrop-filter: blur(10px);
        }

        /* Navigation Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; justify-content: center; }
        .tab-btn { 
            padding: 12px 25px; border: none; border-radius: 50px; 
            font-weight: bold; cursor: pointer; transition: 0.3s; 
            background: #eee; color: #555; 
        }
        .tab-btn.active { background: var(--accent); color: white; transform: scale(1.05); }

        /* Forms */
        .input-group { margin: 15px 0; text-align: left; }
        .input-group label { display: block; font-size: 12px; font-weight: bold; color: #666; margin-bottom: 5px; }
        input, select { 
            width: 100%; padding: 12px; border: 2px solid #ddd; 
            border-radius: 8px; font-size: 16px; box-sizing: border-box; 
        }
        input:focus { border-color: var(--accent); outline: none; }

        /* Buttons */
        .btn-main { 
            width: 100%; padding: 15px; background: #27ae60; color: white; 
            border: none; border-radius: 8px; font-size: 18px; font-weight: bold; 
            cursor: pointer; margin-top: 10px; transition: 0.2s;
        }
        .btn-main:hover { background: #219150; }
        
        .btn-secondary { background: #34495e; margin-top: 10px; padding: 10px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn-download { background: #e74c3c; }

        /* --- CERTIFICATE DESIGNS --- */
        .cert-container { margin-top: 30px; overflow-x: auto; padding: 10px; }
        
        .certificate { 
            width: 800px; height: 500px; margin: auto; padding: 40px; 
            position: relative; box-sizing: border-box; text-align: center;
            background: white; color: black; display: flex; flex-direction: column; justify-content: center;
        }

        /* 1. Classic Gold (Harvard Style) */
        .design-classic {
            border: 20px solid #f1c40f;
            outline: 5px solid #bdc3c7;
            background: radial-gradient(circle, #fffff0, #f0e68c);
            font-family: 'Cinzel', serif;
        }
        .design-classic .c-title { font-size: 40px; color: #2c3e50; border-bottom: 2px solid #f1c40f; display: inline-block; padding-bottom: 10px; }
        .design-classic .c-name { font-size: 48px; margin: 20px 0; color: #d35400; font-weight: bold; text-decoration: underline; }
        
        /* 2. Cyberpunk (Tech Style) */
        .design-cyber {
            background: #000;
            border: 4px solid #0ff;
            box-shadow: 0 0 20px #0ff;
            font-family: 'Orbitron', sans-serif;
            color: #0ff;
        }
        .design-cyber .c-title { font-size: 36px; text-shadow: 0 0 10px #0ff; letter-spacing: 5px; }
        .design-cyber .c-name { font-size: 50px; color: #f0f; text-shadow: 0 0 10px #f0f; margin: 20px 0; }
        .design-cyber .c-body { color: #fff; }

        /* QR Placement */
        .qr-box { margin-top: 20px; display: flex; flex-direction: column; align-items: center; }
        .hash-text { font-size: 10px; margin-top: 5px; max-width: 80%; word-wrap: break-word; opacity: 0.7; }

        /* Scanner */
        #reader { width: 100%; max-width: 400px; margin: auto; border-radius: 10px; overflow: hidden; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" id="t-issue" onclick="switchTab('issue')">Create Certificate</button>
        <button class="tab-btn" id="t-verify" onclick="switchTab('verify')">Verify Certificate</button>
    </div>

    <div id="view-issue">
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <div class="input-group">
                    <label>Candidate Name</label>
                    <input type="text" id="inpName" placeholder="Ex: John Wick" onkeyup="updatePreview()">
                </div>
                <div class="input-group">
                    <label>Course / Achievement</label>
                    <input type="text" id="inpCourse" placeholder="Ex: Advanced Blockchain Security" onkeyup="updatePreview()">
                </div>
                <div class="input-group">
                    <label>Select Theme</label>
                    <select id="inpDesign" onchange="updatePreview()">
                        <option value="design-classic">üèõ Harvard Gold</option>
                        <option value="design-cyber">ü¶æ Cyberpunk 2077</option>
                    </select>
                </div>
                <button class="btn-main" onclick="mintCertificate()">Mint to Blockchain</button>
            </div>
        </div>

        <div id="cert-wrapper" class="cert-container hidden">
            <div id="certificate" class="certificate design-classic">
                <h1 class="c-title">Certificate of Completion</h1>
                <p class="c-body">This certifies that</p>
                <div class="c-name" id="p-name">Student Name</div>
                <p class="c-body">Has successfully demonstrated mastery in</p>
                <h2 id="p-course">Course Name</h2>
                <p class="c-body">Verified on CertiChain Ledger</p>
                
                <div class="qr-box">
                    <div id="qrcode"></div>
                    <div class="hash-text" id="p-hash">BLOCK_HASH_WILL_APPEAR_HERE</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn-secondary btn-download" onclick="downloadPDF()">‚¨á Download PDF</button>
                <button class="btn-secondary" onclick="shareLink()">üîó Copy Share Link</button>
            </div>
        </div>
    </div>

    <div id="view-verify" class="hidden">
        <h2>Blockchain Explorer</h2>
        <p>Scan a QR code or enter a Hash to verify authenticity.</p>
        
        <div id="scan-status" style="margin-bottom: 10px; font-weight: bold;"></div>
        <div id="reader"></div>
        
        <div class="input-group" style="margin-top: 20px;">
            <input type="text" id="manualHash" placeholder="Or paste Hash here...">
            <button class="btn-secondary" onclick="manualVerify()">Verify Hash</button>
        </div>
    </div>
</div>

<script>
    const API_URL = "/api";
    let currentBlock = null;

    // 1. Tab Switching
    function switchTab(tab) {
        document.getElementById('view-issue').classList.toggle('hidden', tab !== 'issue');
        document.getElementById('view-verify').classList.toggle('hidden', tab !== 'verify');
        document.getElementById('t-issue').classList.toggle('active', tab === 'issue');
        document.getElementById('t-verify').classList.toggle('active', tab === 'verify');

        if(tab === 'verify') startScanner();
    }

    // 2. Real-time Preview
    function updatePreview() {
        document.getElementById('p-name').innerText = document.getElementById('inpName').value || "Student Name";
        document.getElementById('p-course').innerText = document.getElementById('inpCourse').value || "Course Name";
        
        const design = document.getElementById('inpDesign').value;
        document.getElementById('certificate').className = `certificate ${design}`;
    }

    // 3. Mint Logic
    async function mintCertificate() {
        const name = document.getElementById('inpName').value;
        const course = document.getElementById('inpCourse').value;
        if(!name || !course) return alert("Please fill all details!");

        const btn = document.querySelector('.btn-main');
        btn.innerText = "Minting..."; btn.disabled = true;

        try {
            const res = await fetch(`${API_URL}/issue?name=${name}&course=${course}`, { method: 'POST' });
            currentBlock = await res.json();
            
            // Show result
            document.getElementById('cert-wrapper').classList.remove('hidden');
            document.getElementById('p-hash').innerText = currentBlock.hash;
            
            // Generate QR
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: currentBlock.hash,
                width: 100, height: 100,
                colorDark : "#000000", colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            alert("‚úÖ Success! Block mined and saved to GitHub.");
        } catch(e) {
            alert("Error connecting to server");
        }
        btn.innerText = "Mint to Blockchain"; btn.disabled = false;
    }

    // 4. Download PDF
    async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const cert = document.getElementById('certificate');
        
        // High quality capture
        const canvas = await html2canvas(cert, { scale: 2 });
        const imgData = canvas.toDataURL('image/png');
        
        const pdf = new jsPDF('l', 'mm', 'a4'); // Landscape, A4
        const width = pdf.internal.pageSize.getWidth();
        const height = pdf.internal.pageSize.getHeight();
        
        pdf.addImage(imgData, 'PNG', 0, 0, width, height);
        pdf.save(`${document.getElementById('inpName').value}_Cert.pdf`);
    }

    // 5. Shareable Link
    function shareLink() {
        if(!currentBlock) return;
        const link = `${window.location.origin}?hash=${currentBlock.hash}`;
        navigator.clipboard.writeText(link);
        alert("Link copied! Send this to anyone to verify.");
    }

    // 6. Verification Logic
    async function verifyHash(hash) {
        document.getElementById('scan-status').innerText = "Searching Blockchain...";
        const res = await fetch(`${API_URL}/verify/${hash}`);
        const text = await res.text();
        
        if(text) {
            const block = JSON.parse(text);
            alert(`‚úÖ VERIFIED!\n\nStudent: ${block.studentName}\nCourse: ${block.courseName}\nDate: ${block.issueDate}`);
            document.getElementById('scan-status').innerHTML = "<span style='color:green'>Verified Successfully</span>";
        } else {
            alert("‚ùå INVALID CERTIFICATE\nHash not found in ledger.");
            document.getElementById('scan-status').innerHTML = "<span style='color:red'>Invalid / Fake</span>";
        }
    }

    // Scanner
    let scanner;
    function startScanner() {
        if(scanner) return;
        scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        scanner.render((decodedText) => {
            scanner.clear();
            verifyHash(decodedText);
        });
    }

    function manualVerify() {
        verifyHash(document.getElementById('manualHash').value);
    }

    // 7. Auto-Deep Link Check (Run on load)
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const hash = urlParams.get('hash');
        if(hash) {
            switchTab('verify');
            document.getElementById('manualHash').value = hash;
            verifyHash(hash);
        }
    }
</script>

</body>
</html>
